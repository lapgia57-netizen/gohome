<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GO HOME</title>
  <link rel="icon" href="https://raw.githubusercontent.com/lapgia57-netizen/gohome/main/favicon.ico" type="image/x-icon">
  <style>
    body { margin:0; font-family: system-ui; background:#0d1117; color:#c9d1d9; }
    .header { background:#010409; padding:20px; text-align:center; border-bottom:3px solid #f85149; }
    h1 { margin:0; color:#f85149; }
    .container { display:flex; height:calc(100vh - 100px); }
    .sidebar { width:35%; background:#161b22; border-right:1px solid #30363d; overflow:auto; }
    .content { width:65%; padding:20px; overflow:auto; }
    .tree ul { padding-left:20px; margin:5px 0; list-style:none; }
    .tree li { padding:6px; cursor:pointer; border-radius:6px; }
    .tree li:hover { background:#30363d; }
    .tree .folder::before { content:"üìÅ "; }
    .tree .file::before { content:"üìÑ "; }
    .search { width:100%; padding:12px; background:#0d1117; border:1px solid #30363d; color:white; box-sizing:border-box; }
    #file-content { background:#0d1117; padding:20px; border-radius:8px; min-height:100%; }
    .online-count { position:fixed; bottom:10px; right:10px; background:#238636; color:white; padding:10px 15px; border-radius:50px; font-weight:bold; z-index:999; }
    .refresh { font-size:12px; color:#8b949e; text-align:center; margin-top:10px; }
    .instructions { background:#21262d; padding:15px; border-radius:8px; margin:10px 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>LCP ‚Äì Ch·ªù t·∫°i qu√°n net</h1>
    <p>ƒêang c√≥ <span id="online">0</span> anh em trong qu√°n (file online) ‚Ä¢ 
       <span style="color:#39d353;">‚óè <span id="realtime-online">0</span> online th·ª±c t·∫ø</span> ‚Ä¢ 
       Click file ƒë·ªÉ m·ªü tab m·ªõi ‚Ä¢ Auto c·∫≠p nh·∫≠t m·ªói 2 ph√∫t</p>
  </div>

  <div class="container">
    <div class="sidebar">
      <input type="text" class="search" id="search" placeholder="T√¨m file, nick, tin nh·∫Øn..."/>
      <div class="tree" id="tree">ƒêang load repo...</div>
    </div>
    <div class="content">
      <div id="file-content">
        <h2>B·∫£ng ƒëi·ªÅu khi·ªÉn Explorer</h2>
        <div class="instructions">
          <strong>Ch·ª©c nƒÉng m·ªõi:</strong><br>
          - <strong>File .html:</strong> M·ªü tab m·ªõi t·∫°i <code>https://back.iq920.fun/[t√™n-file]</code><br>
          - <strong>File kh√°c:</strong> M·ªü raw tr√™n GitHub<br>
          - <strong style="color:#39d353;">‚óè Online th·ªùi gian th·ª±c</strong> b·∫±ng Firebase (t·ª± ƒë·ªông x√≥a khi tho√°t)
          <br><br>
          <strong>M·∫πo:</strong> T·∫°o file <code>online/nick-cua-ban.html</code> ƒë·ªÉ xu·∫•t hi·ªán trong danh s√°ch ‚Äúanh em trong qu√°n‚Äù!
        </div>
        <p><em>Ch·ªçn file b√™n tr√°i ‚Üí m·ªü tab m·ªõi nh√©!</em></p>
      </div>
    </div>
  </div>

  <div class="online-count">Online th·ª±c t·∫ø: <span id="realtime-online2">0</span></div>
  <div class="refresh">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="time"></span></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // === C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N ===
    const firebaseConfig = {
      databaseURL: "https://project-doidoi-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    // Kh·ªüi t·∫°o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const presenceRef = db.ref(".info/connected");
    const usersOnlineRef = db.ref("online-users");

    // T·∫°o ID duy nh·∫•t cho phi√™n truy c·∫≠p (d√πng session + random)
    const sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2);

    // Khi k·∫øt n·ªëi th√†nh c√¥ng ‚Üí ƒë√°nh d·∫•u online
    presenceRef.on("value", (snap) => {
      if (snap.val()) {
        const userRef = usersOnlineRef.child(sessionId);
        userRef.set({
          joinedAt: firebase.database.ServerValue.TIMESTAMP,
          userAgent: navigator.userAgent.substring(0, 100)
        });

        // Khi m·∫•t k·∫øt n·ªëi (ƒë√≥ng tab, tho√°t tr√¨nh duy·ªát, m·∫•t m·∫°ng...) ‚Üí t·ª± ƒë·ªông x√≥a
        userRef.onDisconnect().remove();
      }
    });

    // L·∫Øng nghe s·ªë l∆∞·ª£ng ng∆∞·ªùi online th·ªùi gian th·ª±c
    usersOnlineRef.on("value", (snap) => {
      const count = snap.numChildren();
      document.getElementById("realtime-online").textContent = count;
      document.getElementById("realtime-online2").textContent = count;
    });

    // === PH·∫¶N C≈®: LOAD REPO GITHUB ===
    const owner = "lapgia57-netizen";
    const repo = "gohome";
    const api = `https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`;
    const customDomain = "https://back.iq920.fun/";

    async function loadRepo() {
      try {
        const res = await fetch(api);
        const data = await res.json();
        const files = data.tree.filter(f => f.type === "blob");
        const onlineCount = files.filter(f => f.path.startsWith("online/")).length;

        document.getElementById("online").textContent = onlineCount;

        renderTree(data.tree);
        updateTime();
      } catch (e) {
        document.getElementById("tree").innerHTML = "L·ªói k·∫øt n·ªëi GitHub API :( <br>Repo c√≥ public kh√¥ng bro?";
        console.error(e);
      }
    }

    function renderTree(items) {
      {
      const ul = document.createElement("ul");
      const folders = {};

      items.filter(item => item.type === "blob").forEach(item => {
        const parts = item.path.split('/');
        let current = ul;

        for (let i = 0; i < parts.length - 1; i++) {
          const folderName = parts.slice(0, i + 1).join('/');
          if (!folders[folderName]) {
            const folderLi = document.createElement("li");
            folderLi.className = "folder";
            folderLi.textContent = parts[i] + "/";
            folderLi.onclick = (e) => { e.stopPropagation(); toggleFolder(folderLi); };

            const subUl = document.createElement("ul");
            subUl.style.display = "none";
            folderLi.appendChild(subUl);
            folders[folderName] = { li: folderLi, ul: subUl };

            if (i === 0) ul.appendChild(folderLi);
            else folders[parts.slice(0, i).join('/')].ul.appendChild(folderLi);
          }
          current = folders[folderName].ul;
        }

        const li = document.createElement("li");
        li.className = "file";
        li.textContent = parts[parts.length - 1];
        li.title = item.path;
        li.onclick = (e) => { e.stopPropagation(); openFileInNewTab(item.path); };
        current.appendChild(li);
      });

      // File ·ªü root
      items.filter(item => item.type === "blob" && !item.path.includes('/')).forEach(item => {
        const li = document.createElement("li");
        li.className = "file";
        li.textContent = item.path;
        li.onclick = () => openFileInNewTab(item.path);
        ul.appendChild(li);
      });

      const container = document.getElementById("tree");
      container.innerHTML = "";
      container.appendChild(ul);
    }

    function openFileInNewTab(path) {
      const url = path.endsWith('.html')
        ? customDomain + path
        : `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}`;
      window.open(url, '_blank');
    }

    function toggleFolder(li) {
      const ul = li.querySelector("ul");
      if (ul) ul.style.display = ul.style.display === "none" ? "block" : "none";
    }

    function updateTime() {
      document.getElementById("time").textContent = new Date().toLocaleString("vi-VN");
    }

    // Load + auto refresh
    loadRepo();
    setInterval(loadRepo, 120000);

    // T√¨m ki·∫øm
    document.getElementById("search").addEventListener("input", (e) => {
      const term = e.target.value.toLowerCase();
      document.querySelectorAll(".file, .folder").forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(term) ? "" : "none";
      });
    });
  </script>
</body>
</html>

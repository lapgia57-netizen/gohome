<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tính Tuổi Đến 100 - Đồng bộ Firebase</title>
  <style>
    :root {
      --primary: #4a00e0;
      --accent: #ff6b6b;
      --success: #00b894;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0;
      padding: 20px;
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.25);
      overflow: hidden;
    }
    header {
      background: var(--primary);
      color: white;
      text-align: center;
      padding: 35px 20px;
    }
    h1 { margin: 0; font-size: 2.4em; }
    .subtitle { font-size: 1.2em; opacity: 0.9; margin-top: 10px; }

    .input-section {
      padding: 30px;
      background: #f8f9fa;
      text-align: center;
    }
    .input-group {
      display: flex;
      max-width: 500px;
      margin: 0 auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    input {
      flex: 1;
      padding: 16px 20px;
      font-size: 1.3em;
      border: none;
      outline: none;
      text-align: center;
    }
    button.add {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0 30px;
      font-size: 1.3em;
      cursor: pointer;
      transition: 0.3s;
    }
    button.add:hover { background: #e55a5a; }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      padding: 30px;
      min-height: 200px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      position: relative;
      transition: all 0.3s;
    }
    .card:hover { transform: translateY(-10px); }
    .delete {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #e74c3c;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.1em;
    }
    .year {
      font-size: 3.5em; 
      font-weight: bold; 
      background: linear-gradient(45deg, #ff6b6b, #feca57); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      margin: 10px 0; 
    }
    .period { 
      background: #f1f2f6; 
      padding: 14px; 
      border-radius: 10px; 
      margin: 12px 0; 
      font-weight: 500; 
      font-size: 1.05em; 
    }
    .total { 
      margin-top: 20px; 
      font-weight: bold; 
      color: #0984e3; 
      font-size: 1.1em; 
    }

    footer {
      text-align: center;
      padding: 25px;
      background: #2d3436;
      color: #fff;
    }
    .save-btn, .refresh-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1.1em;
      cursor: pointer;
      margin: 10px 8px;
    }
    .refresh-btn {
      background: #0984e3;
    }
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      display: none;
    }
    .success { background: #d5f4e6; color: #00b894; }
    .error   { background: #fadbd8; color: #e74c3c; }
    .info    { background: #d6eaf8; color: #2980b9; }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.3em;
      color: #666;
    }

    @media (max-width: 600px) {
      .input-group { flex-direction: column; }
      button.add { padding: 16px; }
      h1 { font-size: 2em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Tính Tuổi Đến 100 Tuổi</h1>
      <p class="subtitle">Đồng bộ tự động với Firebase • Cập nhật tháng 12/2025</p>
    </header>

    <div class="input-section">
      <div class="input-group">
        <input type="number" id="birthYear" placeholder="Nhập năm sinh (ví dụ: 1995)" min="1900" max="2025">
        <button class="add" onclick="addYear()">Thêm</button>
      </div>
      <p style="margin-top: 15px; color: #666;">Nhấn Enter hoặc nút Thêm để thêm năm sinh</p>
    </div>

    <div class="cards" id="cards">
      <div class="loading" id="loading">Đang tải dữ liệu từ Firebase...</div>
    </div>

    <footer>
      <p>Tuổi tính theo năm dương lịch (±1 tùy ngày sinh chính xác)</p>
      <button class="refresh-btn" onclick="loadFromFirebase(true)">Tải lại từ Firebase</button>
      <button class="save-btn" onclick="saveToFirebase()" id="saveBtn" style="display:none">Lưu tất cả lên Firebase</button>
      <div id="status" class="status"></div>
    </footer>
  </div>

  <script>
    const cardsContainer = document.getElementById('cards');
    const loadingEl = document.getElementById('loading');
    const saveBtn = document.getElementById('saveBtn');
    const statusEl = document.getElementById('status');

    // Đổi thành URL Firebase Realtime Database của bạn (phải bật rule đọc/ghi public hoặc có auth)
    const firebaseUrl = 'https://project-doidoi-default-rtdb.asia-southeast1.firebasedatabase.app/calculations.json';

    // Cho phép nhấn Enter
    document.getElementById('birthYear').addEventListener('keypress', e => {
      if (e.key === 'Enter') addYear();
    });

    function showStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = 'status ' + type;
      statusEl.style.display = 'block';
      setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
    }

    function calculateAgeData(year) {
      const age2018 = 2018 - year;
      const age2044 =  = 2044 - year;
      const to100     = year + 100;
      const remaining = to100 - 2044;

      return {
        age2018: `2018: <strong>${age2018} tuổi</strong>`,
        age2044: `2044: <strong>${age2044} tuổi</strong> (+26 năm từ 2018)`,
        remaining: `Còn lại đến 100 tuổi: <strong>${remaining} năm</strong> (năm ${to100})`,
        total: `Tổng hành trình: ${year} → ${to100} = 100 năm`
      };
    }

    function createCard(year) {
      const data = calculateAgeData(year);

      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('data-year', year);

      card.innerHTML = `
        <button class="delete" onclick="deleteCard(this)">×</button>
        <div class="year">${year}</div>
        <div class="period">${data.age2018}</div>
        <div class="period">${data.age2044}</div>
        <div class="period">${data.remaining}</div>
        <div class="total">${data.total}</div>
      `;

      return card;
    }

    function deleteCard(btn) {
      btn.parentElement.remove();
      updateSaveButton();
    }

    function addYear() {
      const input = document.getElementById('birthYear');
      let year = parseInt(input.value.trim());

      if (!year || year < 1900 || year > 2025) {
        alert('Vui lòng nhập năm sinh hợp lệ (1900 - 2025)');
        return;
      }

      if (document.querySelector(`[data-year="${year}"]`)) {
        alert('Năm sinh này đã tồn tại!');
        input.value = '';
        return;
      }

      const card = createCard(year);
      cardsContainer.prepend(card);
      input.value = '';
      updateSaveButton();
      showStatus(`Đã thêm năm ${year}`, 'success');
    }

    function updateSaveButton() {
      const hasCards = cardsContainer.children.length > 0 && cardsContainer.children[0].className !== 'loading';
      saveBtn.style.display = hasCards ? 'inline-block' : 'none';
    }

    // === LƯU LÊN FIREBASE ===
    async function saveToFirebase = async () => {
      if (cardsContainer.children.length === 0) {
        showStatus('Không có dữ liệu để lưu!', 'error');
        return;
      }

      const dataToSave = {};
      document.querySelectorAll('.card').forEach(card => {
        const year = card.getAttribute('data-year');
        const periods = card.querySelectorAll('.period');
        const total = card.querySelector('.total').textContent;

        dataToSave[year] = {
          age2018: periods[0].innerHTML,
          age2044: periods[1].innerHTML,
          remainingTo100: periods[2].innerHTML,
          total: total
        };
      });

      try {
        const res = await fetch(firebaseUrl, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            lastUpdated: new Date.now(),
            data: dataToSave
          })
        });

        if (res.ok) {
          showStatus('Đã lưu thành công lên Firebase!', 'success');
        } else {
          throw new Error('HTTP ' + res.status);
        }
      } catch (err) {
        showStatus('Lỗi khi lưu: ' + err.message, 'error');
      }
    };

    // === TẢI DỮ LIỆU TỪ FIREBASE ===
    async function loadFromFirebase(force = false) {
      if (!force) loadingEl.style.display = 'block';

      try {
        const res = await fetch(firebaseUrl + '?t=' + Date.now()); // tránh cache
        if (!res.ok) throw new Error('Không thể kết nối Firebase');

        const json = await res.json();

        // Xóa hết card cũ (trừ loading)
        document.querySelectorAll('.card').forEach(c => c.remove());

        if (json && json.data) {
          const years = Object.keys(json.data).map(Number).sort((a,b) => b - a); // mới nhất lên đầu

          years.forEach(year => {
            const card = document.createElement('div');
            card.className = 'card';
            card.setAttribute('data-year', year);

            const item = json.data[year];
            card.innerHTML = `
              <button class="delete" onclick="deleteCard(this)">×</button>
              <div class="year">${year}</div>
              <div class="period">${item.age2018 || ''}</div>
              <div class="period">${item.age2044 || ''}</div>
              <div class="period">${item.remainingTo100 || ''}</div>
              <div class="total">${item.total || ''}</div>
            `;
            cardsContainer.appendChild(card);
          });

          showStatus(`Đã tải ${years.length} bản ghi từ Firebase (cập nhật lúc ${new Date(json.lastUpdated || Date.now()).toLocaleString('vi')})`, 'info');
        } else {
          showStatus('Firebase trống – bạn có thể thêm dữ liệu mới', 'info');
        }
      } catch (err) {
        showStatus('Lỗi tải dữ liệu: ' + err.message + ' (kiểm tra rule Firebase)', 'error');
      } finally {
        loadingEl.style.display = 'none';
        updateSaveButton();
      }
    }

    // Tự động tải khi mở trang + mỗi 15 giây kiểm tra cập nhật
    window.onload = () => {
      loadFromFirebase();
      setInterval(() => loadFromFirebase(), 15000); // cập nhật mỗi 15s
    };
  </script>
</body>
</html>
